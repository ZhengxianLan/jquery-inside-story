## 属性操作

### 概述

上一章写到了 jQuery 为我们做的 34 项浏览器测试，其中有很多测试的用途中都写到了 `jQuery.***Hooks`，这些都是与属性操作相关的。而 `jQuery.***Hooks` 利用浏览器测试的结果，为相应属性的获取、设置等做出了修正。那么这一章就来看看 jQuery 是如何为我们封装属性操作的。

jQuery 的属性操作分为四大块：HTML 属性操作、DOM 属性操作、类样式操作、值操作。下表是属性操作模块的公开方法，先有个宏观的认识：

|分类|方法|功能|
|---|---|---|
|HTML 属性操作|`.attr(name, value)`|获取匹配元素集合第一个元素的 HTML 属性值，或为匹配元素集合设置一个或多个 HTML 属性|
||`.removeAttr(name)`|从匹配元素集合每个元素上移除一个或多个 HTML 属性，多个 HTML 属性之间用空格分隔|
|DOM 属性操作|`.prop(name, value)`|获取匹配元素集合第一个元素的 DOM 属性值，或为匹配元素集合设置一个或多个 DOM 属性|
||`.removeProp(name)`|从匹配元素集合每个元素上移除一个 DOM 属性|
|类操作|`.addClass(className)`|为每个匹配元素添加一个或多个样式|
||`.removeClass([className])`|从每个匹配元素移除一个或多个样式|
||`.toggleClass([className][,switch])`|为每个匹配元素切换一个或多个样式|
||`.hasClass(selector)`|检查匹配元素集合中的元素，只要任意一个含有指定的样式就返回 `true`|
|值操作|`.val(value)`|获取匹配元素集合中第一个元素的当前值，或修改每个元素的值|

### 总体架构

![](./img/总体架构图.jpg)

### 横扫源码

##### `jQuery.attr(elem, name, value)`

1. 忽略 `nodeType` 为 2、3、8 的节点，它们分别是属性节点、文本节点、注释节点，无法从它们上面 `get/set` 属性。
2. 1.7.1 还支持第四个参数 `pass`，用来表示如果 HTML 属性名与 jQuery 方法同名时的行为，为 `true` 时，并且存在这个属性名对应的方法，那么就会执行。去掉的原因个人认为应该是多此一举了，而且方法的职责也容易混淆。
3. 如果不支持 `getAttribute`，那么读取对应的 DOM 属性。
4. 属性转为小写，然后获取需要的修正对象。
 1. `attrHooks`：特殊属性修正对象。
 2. `boolHook`：布尔属性修正对象。
 3. `nodeHook`：IE 6/7 通用 HTML 属性修正对象。
5. 如果传入了 `value`，表示设置值：
 1. `null`，则移除该属性。
 2. 如果存在修正对象，则根据修正对象的 `set` 进行设置值。
 3. 否则就调用 `elem.setAttribute`。
6. 没有传入 `value`，表示获取值：
 1. 如果存在修正对象，则根据修正对象的 `get` 进行取值。
 2. 否则调用 `jQuery.find.attr(elem, name)` 也就是 `Sizzle.attr(elem, name)`，在 1.7.1 中是直接调用 `getAttribute` 的，1.10.1 中变得挺复杂的，因为跳过了 Sizzle 所以还没很好理解。

###### `boolHook`

修正 HTML 属性值是布尔型的情况。1.10.1 只有 `set` 修正，`get` 修正可能放在了 `Sizzle.attr(elem, name)`，也有可能不需要了。

```
boolHook = {
	// getSetInput：在 IE 9 以下 value 要纠正为 defaultValue
	// getSetAttribute：对于 IE 6、7 来说，需要传入 DOM 属性，而不是 HTML 属性。
	// jQuery.propFix：HTML 属性对应的 DOM 属性。
	set: function( elem, value, name ) {
		if ( value === false ) {
			jQuery.removeAttr( elem, name );
		} else if ( getSetInput && getSetAttribute || !ruseDefault.test( name ) ) {
			elem.setAttribute( !getSetAttribute && jQuery.propFix[ name ] || name, name );
		} else {
			elem[ jQuery.camelCase( "default-" + name ) ] = elem[ name ] = true;
		}
		return name;
	}
};
```

1. 如果 `value` 是 `false`，那么移除该属性。
2. 如果 `!getSetAttribute` 那么就要使用修正的 DOM 属性。`getSetInput` 则用来判断该浏览器是否要修正为 `default*`。 
3. 如果需要修正，则使用 `defaultChecked` 和 `defaultSelected`。（IE 9 以下）

###### `nodeHook`

IE 6/7 不支持部分属性的访问和设置，看看下面的源码就懂了，不过最后的返回值需要到 issue 那看一看。`get` 的修正同样被去掉了。

```
nodeHook = {
	set: function( elem, value, name ) {
		var ret = elem.getAttributeNode( name );
		if ( !ret ) {
			elem.setAttributeNode(
				(ret = elem.ownerDocument.createAttribute( name ))
			);
		}
		ret.value = value += "";
		// Break association with cloned elements by also using setAttribute (#9646)
		return name === "value" || value === elem.getAttribute( name ) ?
			value :
			undefined;
	}
};
```
