## 选择器 Sizzle

### 简介

Sizzle 是一款独立的纯 js 实现的 Css 选择器引擎：

- 相较于其它常用的选择器性能非常有竞争力。
- 压缩、开启 gzip 后只有 4kb。
- 高扩展性、易使用性。
- 支持几乎所有的 Css3 选择器。
- 兼容性好。支持 IE 6.0+、FireFox 3.0+、Chrome 5+、Safari 3+、Opera 9+。

对于实现了 W3C Selector API 的 `querySelector()` 和 `querySelectorAll()` 方法的浏览器，它会直接使用这两个方法。而对于像 IE 6、7 这种，它会自己模拟该方法的行为。

###### 和 jQuery 的关系

选择器 Sizzle 被 jQuery 整合在内部，并且在源码中处于 jQuery 构造模块下面，是非常重要的底层支持模块。jQuery 大多数时候，先调用 Sizzle 查找元素，然后调用 jQuery 方法对查找的结果进行操作。此外也为 jQuery 事件系统的事件代理提供基础功能。

### 总体结构

![](总体结构图)

### 选择器表达式

- 选择器表达式
 - 块表达式
     - 简单表达式
         - id
         - class
         - tag
     - 属性表达式
         - attr
     - 伪类表达式
         - pos（位置）
         - child（子元素）
         - 内容伪类
         - 可见伪类
         - 表单伪类 
 - 块间表达式
     - ">" 父子关系
     - " " 祖先后代关系
     - "+" 紧挨着的兄弟
     - "~" 所有兄弟元素

### 设计思路

书上的这一章个人觉得十分重要，因为实现原理、设计思路对于我们这些使用者来说可能比读源码更重要。这章就针对 `div.red>p` 这个选择器表达式，来讨论一下选择器引擎的工作过程。虽然可能很多人都知道 Css 选择器是从右向左解析的，但还是从这里讲起吧：

- 从左向右查找：先找到 `div.red` 匹配的元素集合，然后查找匹配 `p` 的子元素集合。
- 从右向左查找：先找到 `p` 匹配的元素集合，然后去验证每个元素的父元素是否匹配 `div.red`。

无论是那种思路，都有如下三步要走：

1. 处理选择器表达式：从选择器表达式中解析出块表达式和块间关系符。
2. 处理块表达式：用块表达式的一部分进行查找，剩余部分对结果进行过滤。
3. 处理块间关系符：按照块间关系符查找，用块表达式对结果进行过滤。

###### 从左向右还是从右向左

从左向右查找时，如祖先后代关系，它要处理的子代的数量可能十分庞大，这样通常会导致性能上的问题，尤其是在复杂的页面当中。而从右向左的思路，只要处理单个或者有限数量的祖先元素，在大多数情况下会快很多。出于这个原因，Css 选择器的实现就是使用从右向左的思路。而我们在这里要模拟出选择器的工作，当然也会选择从右向左这种整体更优的方式。

###### Sizzle 就是这么做的

`Sizzle(selector, context, results, seed)` 按照前面三个步骤将下面这些核心接口组织起来，完成选择器的工作：

1. 正则 `chunker` 从选择器表达式中解析出块表达式和块间关系符。
2. `Sizzle.find(expr, context, isXML)` 负责查找块表达式匹配的元素集合。`Sizzle.filter(expr, set, inplace, not)` 负责用块表达式过滤元素集合。
3. `Sizzle.selector.relative` 中的块间关系过滤函数根据块间关系符过滤元素集合。

### `Sizzle(selector, context, results, seed)`

###### 参数

- `selector`：选择器表达式。
- `context`：限定查找的上下文，默认为 `document`。
- `results`：可选的数组或类数组，查到的元素会被添加进去，默认为 `[]`。
- `seed`：可选的元素集合，将从中过滤出匹配选择器表达式的元素集合。



