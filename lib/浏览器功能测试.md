## 浏览器功能测试

一般解决浏览器不兼容的问题有两种方式：一是浏览器嗅探；二是浏览器功能测试。

前者通过解析 `navigator.userAgent` 来过去浏览器的类型和版本信息，然后编写相应的兼容代码，其缺陷是编写的代码与特定的浏览器和版本绑定，因此在 1.10.1 中，jQuery 本身貌似已经把浏览器嗅探相关的 `browser` 和 `uaMatch` 从 jQuery 静态属性和方法中移除了。后者通过测试某项功能是否被支持来编写兼容性代码，通用性更好。

### DOM 测试项

###### `leadingWhitespace`
 
测试 `innerHTML` 属性插入 HTML 代码时保留前导空白符。在 IE 6-8 下，前导空白符会被剔除。这个运用在第二章的 `jQuery.buildFragment` 方法中，测试为 `false` 则会创建文本节点并加进去。

```
div = document.createElement("div");
div.innerHTML = "  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>";
support.leadingWhitespace = div.firstChild.nodeType === 3;
```

###### `tbody`

测试空的 `table` 可以存在，且不包含 `tbody`。IE 6、7 会自动为空的 `table` 插入 `tbody`。这个运用在第二章的 `jQuery.buildFragment` 方法中，测试为 `false` 则会去除自动添加的 `tbody`。

```
div = document.createElement("div");
div.innerHTML = "  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>";
support.tbody = !div.getElementsByTagName("tbody").length;
```

###### `htmlSerialize`

`innerHTML` 是否能够正确的序列化 `link` 标签。IE 6-8 下不能正确序列化，返回 `false`。这个运用在第二章的 `jQuery.buildFragment` 方法的包裹策略中，测试为 `false` 会在 `link` 和 `script` 外再包一层 `div<div></div>` 这样就能够序列化了，最后再把外层给剥除。
```
div = document.createElement("div");
div.innerHTML = "  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>";
support.htmlSerialize = !!div.getElementsByTagName("link").length;
```

###### `hrefNormalized`

测试 `getAttribute('href')` 得到的值没有被格式化过，IE 6、7 会把相对路径格式化为全路径。`jQuery.propHooks` 初始化时，如果测试为 `false`，那么会创建 `href` 和 `src` 的修正方法，在读取属性时优先调用修正方法，利用的是 IE 下 `getAttribute` 的第二个参数为 4。

```
div = document.createElement("div");
div.innerHTML = "  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>";
support.hrefNormalized = a.getAttribute("href") === "/a";
```

###### `checkOn`

复选框默认值为 `on`，测试结果为 `true`。这是针对 Safari 5.1.5 的兼容。在 `jQuery.valHooks` 初始化时，如果测试为 `false`，那么创建修正方法，一律返回 `on`。那么在调用 `val(value)` 时，会优先调用修正方法。

```
div = document.createElement("div");
div.innerHTML = "  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>";
input = div.getElementsByTagName("input")[ 0 ];
support.checkOn = !!input.value;
```

###### `noCloneChecked`

`cloneNode` 复制选中的状态的话，则测试为 `true`。IE 全部 gg。在 `jQuery.clone` 中被用到，如果原始元素的 `checked` 为 true，那么它会把复制元素的 `defaultChecked` 和 `checked` 设为原始元素的 `checked` 属性值。

```
div = document.createElement("div");
div.innerHTML = "  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>";
input = div.getElementsByTagName("input")[ 0 ];
input.checked = true;
support.noCloneChecked = input.cloneNode( true ).checked;
```

###### `optSelected`

默认选中的 `option` 的 `selected` 为 `true`，则探测结果为 `true`。对于 IE 和 Safari 4.0 探测的结果是 `false`。在 `jQuery.propHooks` 初始化时，如果测试结果是 `false`，那么通过父元素 `select` 或 父元素 `optgroup` 的属性 `selectedIndex` 来触发修正。

```
select = document.createElement("select");
opt = select.appendChild( document.createElement("option") );
support.optSelected = opt.selected;
``` 

###### `optDisabled`

如果 `select` 被禁用，而 `option` 未被自动禁用，那么测试项为 `true`。Safari 4.0 下有这种情况。同样是在 `valHooks` 中，如果会自动禁用，则从 HTML 属性来判断，否则通过 DOM 属性。

```
select = document.createElement("select");
opt = select.appendChild( document.createElement("option") );
select.disabled = true;
support.optDisabled = !opt.disabled;
```

###### `getSetAttribute`

如果 `getAttribute`、`setAttribute`、`removeAttribute` 可以正确执行，那么测试项为 `true`。对于 IE 6、7 来说，需要传入 DOM 属性，而不是 HTML 属性，例如 `class` 需要传入 DOM 属性 `className` 才能拿到，而其他浏览器是传入 DOM 属性时无效的。

涉及的属性有以下几个：`className`、`tabindex`、`readonly`、`for`、`class`、`class`、`cellspacing`、`cellpadding`、`rowspan`、`colspan`、`usemap`、`frameborder`、`contenteditable`等。

```
div.setAttribute( "className", "t" );
support.getSetAttribute = div.className !== "t";
```

###### `deleteExpando`

如果浏览器允许删除 DOM 上的属性，那么测试项为 `true`。IE 6-8 均不允许，因此是 `false`。`jQuery.removeData` 和 `jQuery.cleanData` 中用到，如果不能够 `delete`，那么就赋值为 `null`。

```
try {
	delete div.test;
} catch( e ) {
	support.deleteExpando = false;
}
```

###### `enctype`

表单元素支持 `enctype` 测试项为 `true`。`enctype` 用于指定表单数据发送到服务器之前应该如何对其进行编码，与 `encoding` 等价，但是旧浏览器只支持 `encoding`。FireFox 3.6.8 测试为 `false`。`jQuery.prop` 和 `jQuery.removeProp` 中会先尝试从 `jQuery.propFix` 中读取，这里存储了上面提到的 HTML 属性和 DOM 属性的映射。在不支持 `enctype` 中将转为对 `encoding` 的操作。

```
support.enctype = !!document.createElement("form").enctype;
```

###### `html5Clone`

如果能够正确地复制 HTML5 元素，测试项为 `true`。IE 6-8 中为 `false`。

```
support.html5Clone = document.createElement("nav").cloneNode( true ).outerHTML !== "<:nav></:nav>";
```

###### `radioValue`

如果设置 `input.value` 为 `radio` 不会导致 `value` 丢失，那么测试项为 `true`。IE 又全军覆没。在 `jQuery.attrHooks` 初始化时，创建了对应的修正方法，如果测试为 `false`，那么会先备份 `value`，然后再恢复。 

```
input = document.createElement("input");
input.value = "t";
input.setAttribute( "type", "radio" );
support.radioValue = input.value === "t";
```

###### `checkClone`

文档片段中能正确复制单选和复选的选中状态，测试为 `true`。还是 IE 6、7 的锅。

```
input = document.createElement("input");
input.setAttribute( "type", "radio" );
input.setAttribute( "checked", "t" );
input.setAttribute( "name", "t" );
fragment = document.createDocumentFragment();
fragment.appendChild( input );
support.checkClone = fragment.cloneNode( true ).cloneNode( true ).lastChild.checked;
```

###### `appendChecked`

已选中的单选框或复选框添加到 DOM 树中后还是选中，那么测试项为 `true`。又是 IE 6、7。`jQuery.buildFragment` 方法中，在 HTML 转为 DOM 后，会把所有的 `input` 找出来，来修正 `checked` 丢失的问题。

```
input = document.createElement("input");
input.setAttribute( "type", "radio" );
input.setAttribute( "checked", "t" );
input.setAttribute( "name", "t" );
support.appendChecked = input.checked;
```

###### `input`

1.7.1 中没有这个，用来判断 `input.getAttribute` 是否值得信任。具体需要有网时查，书上没这个。

```
input = document.createElement("input");
input.setAttribute( "value", "" );
support.input = input.getAttribute( "value" ) === "";
```

### 样式测试

###### style

DOM 内联样式可以通过 `style` 拿到那么测试项为 `true`。在 IE 6-8 下面，需要通过 `style.cssText` 访问内联样式。在 `jQuery.attrHooks` 初始化时，如果测试项为 `false`，修正 `jQuery.attrHooks.style.get/set` 通过 `elem.style.cssText` 来获取和设置内联样式。 

```
support.style = /top/.test( a.getAttribute("style") );
```

###### `opacity`

如果浏览器支持 `opacity` 那么测试项为 `true`。IE 6-8，不支持，需要使用滤镜（alpha filters）代替。在 `jQuery.cssHooks` 初始化时，如果测试项为 `false`，则对 `jQuery.cssHooks.opacity.get/set` 进行修正，通过 `elem.currentStyle.filter` 或 `elem.style.filter` 来操作 `opacity` 样式。

```
a = div.getElementsByTagName("a")[ 0 ];
a.style.cssText = "top:1px;float:left;opacity:.5";
support.opacity = /^0.5/.test( a.style.opacity );
```

> 正则 `/^0.5/` 的小历史，为什么使用 `.5` 而不是 `0.5`，这是因为 IE 6-8 会返回 `.5` 其它支持的浏览器会返回 `0.5`，这样就可以测试出来。在 jQuery 1.4 中，这个正则是 `/^0.55$/`，因为 Opera 9.2 以前会把，`0.5` 解析成 `0.50` 导致测试出错，现在便会 `0.5` 可能是不再支持 Opera 9.2 了吧。而去掉 `$`，是因为早期的 WebKit 返回的小数位可能很长，而不是两位。忘了最后还有一点，就是正则中的点为什么不转义，原因是部分浏览器返回的是逗号。

###### `cssFloat`

如果浏览器支持使 `style.cssFloat` 访问样式 `float`，测试项为 `true`。在 IE 6-8 中，都要使用 `style.styleFloat` 来访问 `float` 样式。在 `jQuery.cssProps` 中如果测试项为 `true`，则会修正样式名为 `cssFloat` 否则为 `styleFloat`。在 `jQuery.style` 读取和设置内联样式前，会从 `jQuery.cssProps` 取出修正的样式名。`jQuery.css` 也是如此。

```
a = div.getElementsByTagName("a")[ 0 ];
a.style.cssText = "top:1px;float:left;opacity:.5";
support.cssFloat = !!a.style.cssFloat;
```

### 事件测试

###### `noCloneEvent`

浏览器在复制 DOM 元素时，不会把事件一起复制，测试项为 `false`。在 IE 6-8 中会连同监听的事件一并复制。`jQuery.clone` 在复制 DOM 元素后，会判断这个测试项，如果为 `false`，会在 `fixCloneNodeIssues` 中清除事件和扩展属性 `jQuery.expando`。

```
if ( div.attachEvent ) {
	div.attachEvent( "onclick", function() {
		support.noCloneEvent = false;
	});

	div.cloneNode( true ).click();
}
```

###### `submitBubbles`、`changeBubbles`、`focusinBubbles`

IE 6-8，`submit` 和 `change` 事件不会向上冒泡。而除了 IE 好像没有 `focusin` 和 `focusout` 事件。对于不支持的情况，jQuery 事件系统会进行模拟。

```
for ( i in { submit: true, change: true, focusin: true }) {
	div.setAttribute( eventName = "on" + i, "t" );

	support[ i + "Bubbles" ] = eventName in window || div.attributes[ eventName ].expando === false;
}
```

### Ajax 测试

###### `ajax`、`cors`

如果浏览器可以创建 `XMLHttpRequest`，那么测试为 `true`。这个好像大家都支持，不支持的应该是 IE 6 以下的版本，这部分基本可以不用考虑了。

如果浏览器支持跨域资源共享，测试项为 `true`。IE 6、7 完全不支持，IE 8、9 通过 `XDomainRequest` 部分支持。

```
function createStandardXHR() {
	try {
		return new window.XMLHttpRequest();
	} catch( e ) {}
}
function createActiveXHR() {
	try {
		return new window.ActiveXObject("Microsoft.XMLHTTP");
	} catch( e ) {}
}
jQuery.ajaxSettings.xhr = window.ActiveXObject ?
	// 这里的 isLocal 是判断是否是对本地资源的请求，IE 7 的 XMLHttpRequest 不能够请求本地资源
	// 因此会使用 ActiveXObject，另外 IE 7、8 中的 XMLHttpRequest 可以被禁，因此需要一个兼容
	function() {
		return !this.isLocal && createStandardXHR() || createActiveXHR();
	} :
	createStandardXHR;

xhrSupported = jQuery.ajaxSettings.xhr();
jQuery.support.cors = !!xhrSupported && ( "withCredentials" in xhrSupported );
xhrSupported = jQuery.support.ajax = !!xhrSupported;
```

### 盒模型测试

###### `reliableMarginRight`




 